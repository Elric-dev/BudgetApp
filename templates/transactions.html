{% extends "layout.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="text-info"><i class="bi bi-list-check me-2"></i>Expense Explorer</h3>
    <span class="badge bg-dark border border-secondary text-muted" id="total-count-badge">Total Entries: 0</span>
</div>

<div class="card bg-dark border-secondary shadow-lg">
    <div class="table-responsive">
        <table class="table table-dark table-hover align-middle mb-0">
            <thead class="table-secondary text-dark">
                <tr>
                    <th style="width: 120px;">Date</th>
                    <th style="width: 200px;">Category</th>
                    <th>Description</th>
                    <th>Total (â‚¬)</th>
                    <th>Gus Share</th>
                    <th>Joules Share</th>
                    <th class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody id="transaction-rows">
                </tbody>
        </table>
    </div>
</div>

<nav aria-label="Page navigation" class="mt-4">
    <ul class="pagination justify-content-center" id="pagination-controls"></ul>
</nav>

<style>
    .date-text {
        color: #ffc107 !important;
        font-family: 'Courier New', Courier, monospace;
        font-weight: bold;
    }
    
    .table-hover tbody tr:hover {
        background-color: rgba(255, 255, 255, 0.05);
    }

    /* Category Dropdown Styling */
    .cat-select {
        background-color: #080808 !important;
        color: #0dcaf0 !important;
        border: 1px solid #444 !important;
        font-size: 0.85rem;
        padding: 0.25rem 0.5rem;
    }

    [contenteditable="true"]:focus {
        outline: 2px solid #0dcaf0;
        background: rgba(13, 202, 240, 0.1);
        padding: 2px 5px;
        border-radius: 4px;
    }

    .page-link { background-color: #1f1f1f; border-color: #333; color: #0dcaf0; }
    .page-item.active .page-link { background-color: #0dcaf0; border-color: #0dcaf0; color: #000; }
</style>



<script>
let currentPage = 1;
let categoriesList = []; // Global store for category dropdown

// Fetch categories once to use in the table rows
async function fetchCategories() {
    try {
        const res = await fetch('/api/categories'); // Adjust endpoint as needed
        categoriesList = await res.json();
    } catch (e) { console.error("Could not load categories", e); }
}

async function loadTable(page = 1) {
    if (categoriesList.length === 0) await fetchCategories();
    
    currentPage = page;
    try {
        const res = await fetch(`/api/transactions?page=${page}`);
        const data = await res.json();
        
        const container = document.getElementById('transaction-rows');
        document.getElementById('total-count-badge').innerText = `Total Entries: ${data.total}`;

        if (data.transactions.length === 0) {
            container.innerHTML = '<tr><td colspan="7" class="text-center py-5">No transactions found.</td></tr>';
            return;
        }

       container.innerHTML = data.transactions.map(t => {
    // Generate options and explicitly check for a match with t.category_id
    const catOptions = categoriesList.map(c => {
        // Compare the category ID from the list to the transaction's category_id
        const isSelected = (c.id === t.category_id) ? 'selected' : '';
        
        // Show parent name if it exists for better context (e.g., "Heat (Utilities)")
        const displayLabel = c.parent_name ? `${c.name} (${c.parent_name})` : c.name;
        
        return `<option value="${c.id}" ${isSelected}>${displayLabel}</option>`;
    }).join('');

    return `
    <tr id="row-${t.id}">
        <td class="date-text">${t.clean_date}</td>
        <td>
            <select class="form-select form-select-sm cat-select" id="cat-${t.id}">
                ${catOptions}
            </select>
        </td>
        <td contenteditable="true" id="desc-${t.id}">${t.description}</td>
        <td contenteditable="true" id="amt-${t.id}" class="fw-bold text-white">${t.total_amount}</td>
        <td contenteditable="true" id="gus-${t.id}" class="text-success">${t.Gus_share}</td>
        <td contenteditable="true" id="joules-${t.id}" class="text-warning">${t.Joules_share}</td>
        <td class="text-center">
            <button onclick="saveEdit(${t.id})" class="btn btn-sm btn-success">
                <i class="bi bi-check-lg"></i> Save
            </button>
        </td>
    </tr>`;
}).join('');
        
        renderPagination(data.total, page);
    } catch (error) {
        console.error("Failed to load table:", error);
    }
}

async function saveEdit(id) {
    const payload = {
        id: id,
        category_id: document.getElementById(`cat-${id}`).value,
        description: document.getElementById(`desc-${id}`).innerText,
        total_amount: document.getElementById(`amt-${id}`).innerText,
        Gus_share: document.getElementById(`gus-${id}`).innerText,
        Joules_share: document.getElementById(`joules-${id}`).innerText
    };

    try {
        const res = await fetch('/api/transactions/update', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        
        if (res.ok) {
            const btn = document.querySelector(`#row-${id} button`);
            btn.innerHTML = '<i class="bi bi-check-all"></i> Saved!';
            btn.classList.replace('btn-success', 'btn-outline-success');
            setTimeout(() => {
                btn.innerHTML = '<i class="bi bi-check-lg"></i> Save';
                btn.classList.replace('btn-outline-success', 'btn-success');
            }, 2000);
        } else {
            alert("Error updating record.");
        }
    } catch (err) {
        console.error("Save failed:", err);
    }
}

function renderPagination(totalEntries, page) {
    const totalPages = Math.ceil(totalEntries / 20);
    const controls = document.getElementById('pagination-controls');
    let html = '';
    html += `<li class="page-item ${page === 1 ? 'disabled' : ''}"><a class="page-link" href="#" onclick="loadTable(${page - 1})">Previous</a></li>`;
    let startPage = Math.max(1, page - 2);
    let endPage = Math.min(totalPages, page + 2);
    for (let i = startPage; i <= endPage; i++) {
        html += `<li class="page-item ${i === page ? 'active' : ''}"><a class="page-link" href="#" onclick="loadTable(${i})">${i}</a></li>`;
    }
    html += `<li class="page-item ${page === totalPages ? 'disabled' : ''}"><a class="page-link" href="#" onclick="loadTable(${page + 1})">Next</a></li>`;
    controls.innerHTML = html;
}

document.addEventListener('DOMContentLoaded', () => loadTable(1));
</script>
{% endblock %}