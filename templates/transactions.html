{% extends "layout.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="text-info"><i class="bi bi-list-check me-2"></i>Expense Explorer</h3>
    <span class="badge bg-dark border border-secondary text-muted" id="total-count-badge">Total Entries: 0</span>
</div>

<div class="card bg-dark border-secondary shadow-lg">
    <div class="table-responsive">
        <table class="table table-dark table-hover align-middle mb-0">
            <thead class="table-secondary text-dark">
                <tr>
                    <th style="width: 120px;">Date</th>
                    <th>Category</th>
                    <th>Description</th>
                    <th>Total (â‚¬)</th>
                    <th>Gus Share</th>
                    <th>Joules Share</th>
                    <th class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody id="transaction-rows">
                </tbody>
        </table>
    </div>
</div>

<nav aria-label="Page navigation" class="mt-4">
    <ul class="pagination justify-content-center" id="pagination-controls">
        </ul>
</nav>

<style>
    /* Fix for date readability */
    .date-text {
        color: #ffc107 !important; /* Amber/Yellow for high contrast */
        font-family: 'Courier New', Courier, monospace;
        font-weight: bold;
    }
    
    .table-hover tbody tr:hover {
        background-color: rgba(255, 255, 255, 0.05);
    }

    [contenteditable="true"]:focus {
        outline: 2px solid #0dcaf0;
        background: rgba(13, 202, 240, 0.1);
        padding: 2px 5px;
        border-radius: 4px;
    }

    .page-link {
        background-color: #1f1f1f;
        border-color: #333;
        color: #0dcaf0;
    }

    .page-item.active .page-link {
        background-color: #0dcaf0;
        border-color: #0dcaf0;
        color: #000;
    }

    .page-item.disabled .page-link {
        background-color: #121212;
        border-color: #222;
        color: #444;
    }
</style>

[Image of a data table with pagination and sorting controls]

<script>
let currentPage = 1;

async function loadTable(page = 1) {
    currentPage = page;
    try {
        const res = await fetch(`/api/transactions?page=${page}`);
        const data = await res.json();
        
        const container = document.getElementById('transaction-rows');
        document.getElementById('total-count-badge').innerText = `Total Entries: ${data.total}`;

        if (data.transactions.length === 0) {
            container.innerHTML = '<tr><td colspan="7" class="text-center py-5">No transactions found.</td></tr>';
            return;
        }

        container.innerHTML = data.transactions.map(t => `
            <tr id="row-${t.id}">
                <td class="date-text">${t.clean_date}</td>
                <td><span class="badge rounded-pill bg-outline-info border border-info text-info">${t.category_name}</span></td>
                <td contenteditable="true" id="desc-${t.id}">${t.description}</td>
                <td contenteditable="true" id="amt-${t.id}" class="fw-bold text-white">${t.total_amount}</td>
                <td contenteditable="true" id="gus-${t.id}" class="text-success">${t.Gus_share}</td>
                <td contenteditable="true" id="joules-${t.id}" class="text-warning">${t.Joules_share}</td>
                <td class="text-center">
                    <button onclick="saveEdit(${t.id})" class="btn btn-sm btn-success">
                        <i class="bi bi-check-lg"></i> Save
                    </button>
                </td>
            </tr>
        `).join('');
        
        renderPagination(data.total, page);
    } catch (error) {
        console.error("Failed to load table:", error);
    }
}

function renderPagination(totalEntries, page) {
    const totalPages = Math.ceil(totalEntries / 20);
    const controls = document.getElementById('pagination-controls');
    let html = '';

    // Previous Button
    html += `
        <li class="page-item ${page === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadTable(${page - 1})">Previous</a>
        </li>
    `;

    // Page Numbers (Showing a max of 5 pages around the current page for brevity)
    let startPage = Math.max(1, page - 2);
    let endPage = Math.min(totalPages, page + 2);

    for (let i = startPage; i <= endPage; i++) {
        html += `
            <li class="page-item ${i === page ? 'active' : ''}">
                <a class="page-link" href="#" onclick="loadTable(${i})">${i}</a>
            </li>
        `;
    }

    // Next Button
    html += `
        <li class="page-item ${page === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadTable(${page + 1})">Next</a>
        </li>
    `;

    controls.innerHTML = html;
}

async function saveEdit(id) {
    const payload = {
        id: id,
        description: document.getElementById(`desc-${id}`).innerText,
        amount: document.getElementById(`amt-${id}`).innerText,
        gus: document.getElementById(`gus-${id}`).innerText,
        joules: document.getElementById(`joules-${id}`).innerText
    };

    try {
        const res = await fetch('/api/transactions/update', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        
        const result = await res.json();
        if (result.status === "success") {
            const btn = document.querySelector(`#row-${id} button`);
            btn.innerHTML = '<i class="bi bi-check-all"></i> Saved!';
            btn.classList.replace('btn-success', 'btn-outline-success');
            setTimeout(() => {
                btn.innerHTML = '<i class="bi bi-check-lg"></i> Save';
                btn.classList.replace('btn-outline-success', 'btn-success');
            }, 2000);
        } else {
            alert("Error updating record.");
        }
    } catch (err) {
        console.error("Save failed:", err);
    }
}

// Initialize on load
document.addEventListener('DOMContentLoaded', () => loadTable(1));
</script>
{% endblock %}