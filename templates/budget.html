{% extends "layout.html" %}

{% block content %}
<style>
    /* High-Contrast Typography */
    .text-light {
        color: #f8f9fa !important;
        font-weight: 600;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }

    /* Projection Summary Labels (Brighter) */
    .summary-label {
        color: #e0e0e0 !important;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 0.85rem;
    }

    /* High-contrast colors for Euro values */
    #proj-income { color: #ffffff !important; font-weight: bold; font-size: 1.3rem; }
    #proj-savings { color: #2ecc71 !important; font-weight: bold; font-size: 1.3rem; }
    #proj-burn { color: #f1c40f !important; font-weight: bold; font-size: 1.3rem; }

    /* Input Styling */
    .cat-budget-input {
        background-color: #1a1a1a !important;
        color: #0dcaf0 !important;
        border: 1px solid #444 !important;
        font-weight: bold;
        text-align: right;
    }

    .cat-budget-input:focus {
        background-color: #000 !important;
        border-color: #0dcaf0 !important;
        box-shadow: 0 0 8px rgba(13, 202, 240, 0.5);
    }

    #category-list::-webkit-scrollbar { width: 6px; }
    #category-list::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }
    
    .border-bottom-custom { border-bottom: 1px solid #333 !important; }
</style>

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="text-info"><i class="bi bi-wallet2 me-2"></i>Budget Planner</h3>
        <div class="d-flex align-items-center gap-2">
            <label class="small text-muted text-uppercase fw-bold mb-0">Profile:</label>
            <select id="userSelect" class="form-select bg-dark text-white border-secondary" style="width: 160px;" onchange="initBudgetPage()">
                <option value="0">Gus</option>
                <option value="1">Joules</option>
                <option value="2">üè† Household</option>
            </select>
        </div>
    </div>

    <div class="row">
        <div class="col-md-5">
            <div class="card bg-dark border-secondary p-4 shadow-lg mb-4">
                <h5 class="text-white mb-4 border-bottom border-info pb-2 text-uppercase" style="letter-spacing: 1px;">Global Strategy</h5>
                
                <div class="mb-4">
                    <label class="text-success small fw-bold text-uppercase d-block mb-2">Savings & Investment Goal (%)</label>
                    <div class="input-group">
                        <input type="number" id="savings_pct" class="form-control bg-black text-white border-secondary" value="20" oninput="calculateProjections()">
                        <span class="input-group-text bg-secondary border-secondary text-white">%</span>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="text-warning small fw-bold text-uppercase d-block mb-2">Max Monthly Burn (%)</label>
                    <div class="input-group">
                        <input type="number" id="expenses_pct" class="form-control bg-black text-white border-secondary" value="50" oninput="calculateProjections()">
                        <span class="input-group-text bg-secondary border-secondary text-white">%</span>
                    </div>
                </div>

                <div class="p-4 bg-black rounded border border-secondary shadow-sm">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="summary-label">Total Net Income:</span>
                        <span id="proj-income">‚Ç¨0.00</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="summary-label">Target Savings:</span>
                        <span id="proj-savings">‚Ç¨0.00</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="summary-label">Allowed Spend:</span>
                        <span id="proj-burn">‚Ç¨0.00</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-7">
            <div class="card bg-dark border-secondary p-4 shadow-lg">
                <div class="d-flex justify-content-between align-items-center mb-4 border-bottom border-info pb-2">
                    <h5 class="text-white mb-0 text-uppercase" style="letter-spacing: 1px;">Itemized Monthly Expenses</h5>
                    <span id="cat-count" class="badge bg-info text-dark">0 Categories</span>
                </div>

                <div id="category-list" style="max-height: 480px; overflow-y: auto;" class="pe-2">
                    </div>

                <div class="mt-4 pt-3 border-top border-secondary d-flex justify-content-between align-items-center">
                    <div>
                        <small class="summary-label d-block">Total Itemized</small>
                        <h3 id="itemized-total" class="text-white mb-0">‚Ç¨0.00</h3>
                    </div>
                    <button class="btn btn-info fw-bold px-5 py-2 shadow" onclick="saveAllBudgetData()">
                        <i class="bi bi-cloud-check-fill me-2"></i>SAVE ALL TARGETS
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let netIncome = 0;

document.addEventListener('DOMContentLoaded', initBudgetPage);

async function initBudgetPage() {
    const userId = document.getElementById('userSelect').value;
    
    // 1. Get current income for the profile
    const resSummary = await fetch(`/api/dashboard/summary?user_id=${userId}`);
    const summary = await resSummary.json();
    netIncome = summary.income || 0;
    document.getElementById('proj-income').innerText = `‚Ç¨${netIncome.toLocaleString()}`;

    // 2. Load categories from DB
    await loadCategoryItems(userId);
    
    calculateProjections();
}

async function loadCategoryItems(userId) {
    const listContainer = document.getElementById('category-list');
    
    try {
        const res = await fetch(`/api/budget/list?user_id=${userId}`);
        const categories = await res.json();

        if (!Array.isArray(categories)) {
            listContainer.innerHTML = `<div class="alert alert-danger">Error: ${categories.error}</div>`;
            return;
        }

        document.getElementById('cat-count').innerText = `${categories.length} Categories`;

        listContainer.innerHTML = categories.map(c => `
            <div class="row g-2 align-items-center mb-2 pb-2 border-bottom-custom">
                <div class="col-7">
                    <span class="text-light">${c.name}</span>
                </div>
                <div class="col-5">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-black border-secondary text-success">‚Ç¨</span>
                        <input type="number" 
                               class="form-control cat-budget-input" 
                               data-name="${c.name}" 
                               value="${c.amount || 0}" 
                               oninput="calculateItemizedTotal()">
                    </div>
                </div>
            </div>
        `).join('');

        calculateItemizedTotal();
    } catch (err) {
        console.error(err);
        listContainer.innerHTML = `<div class="text-danger">Failed to fetch data.</div>`;
    }
}

function calculateItemizedTotal() {
    let total = 0;
    document.querySelectorAll('.cat-budget-input').forEach(input => {
        total += parseFloat(input.value) || 0;
    });
    document.getElementById('itemized-total').innerText = `‚Ç¨${total.toLocaleString()}`;
    
    // Sync the "Burn %" based on itemized total
    if (netIncome > 0) {
        const burnPct = (total / netIncome) * 100;
        document.getElementById('expenses_pct').value = burnPct.toFixed(1);
        calculateProjections();
    }
}

function calculateProjections() {
    const sPct = parseFloat(document.getElementById('savings_pct').value) || 0;
    const ePct = parseFloat(document.getElementById('expenses_pct').value) || 0;

    const sEur = (netIncome * sPct) / 100;
    const eEur = (netIncome * ePct) / 100;

    document.getElementById('proj-savings').innerText = `‚Ç¨${sEur.toLocaleString()}`;
    document.getElementById('proj-burn').innerText = `‚Ç¨${eEur.toLocaleString()}`;
}

async function saveAllBudgetData() {
    const userId = document.getElementById('userSelect').value;
    const inputs = document.querySelectorAll('.cat-budget-input');
    
    const items = Array.from(inputs).map(i => ({
    name: i.dataset.name, // This creates the 'name' key for Python
    amount: parseFloat(i.value) || 0
}));

    const res = await fetch('/api/budget/save_items', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            user_id: parseInt(userId),
            items: items,
            savings_pct: parseFloat(document.getElementById('savings_pct').value),
            expenses_pct: parseFloat(document.getElementById('expenses_pct').value)
        })
    });

    if (res.ok) {
        alert("Success: Strategy updated!");
    } else {
        const err = await res.json();
        alert("Error: " + err.error);
    }
}
</script>
{% endblock %}