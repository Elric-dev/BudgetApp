{% extends "layout.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div class="d-flex align-items-center">
        <h3 class="text-info mb-0"><i class="bi bi-speedometer2 me-2"></i>Financial Overview</h3>
    </div>
    <div class="text-end">
        <span class="small text-light text-uppercase fw-bold d-block" style="letter-spacing: 1px;">Total Period Spending</span>
        <span class="h3 mb-0 text-warning fw-bold" id="totalDisplay">€0.00</span>
    </div>
</div>

<div class="card mb-4 shadow-sm border-0" style="background-color: #1f1f1f;">
    <div class="card-body d-flex gap-3 align-items-center flex-wrap">
        <div class="d-flex align-items-center gap-2">
            <label class="small text-muted text-uppercase fw-bold">User:</label>
            <select id="userFilter" class="form-select form-select-sm bg-dark text-white border-secondary" onchange="renderDashboard()">
                <option value="all">Household</option>
                <option value="0">Gus</option>
                <option value="1">Joules</option>
            </select>
        </div>
        <div class="d-flex align-items-center gap-2 border-start ps-3">
            <label class="small text-muted text-uppercase fw-bold">From:</label>
            <input type="date" id="startDate" class="form-control form-control-sm bg-dark text-white border-secondary">
        </div>
        <div class="d-flex align-items-center gap-2">
            <label class="small text-muted text-uppercase fw-bold">To:</label>
            <input type="date" id="endDate" class="form-control form-control-sm bg-dark text-white border-secondary">
        </div>
        <button class="btn btn-sm btn-info px-3 fw-bold" onclick="fetchData()">Update</button>
        <button class="btn btn-sm btn-outline-secondary" onclick="resetToAllTime()">All Time</button>
    </div>
</div>

<div class="row">
    <div class="col-lg-7 mb-4">
        <div class="card h-100 shadow-sm border-0 bg-dark text-white">
            <div class="card-header bg-transparent border-0 pt-3">
                <h6 class="text-muted text-uppercase small fw-bold">Spending by Category</h6>
            </div>
            <div class="card-body">
                <div style="height: 350px; position: relative;">
                    <canvas id="spendingChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-5 mb-4">
        <div class="card h-100 shadow-sm border-0 bg-dark text-white">
            <div class="card-header bg-transparent border-0 pt-3">
                <h6 class="text-muted text-uppercase small fw-bold">Quick Breakdown</h6>
            </div>
            <div class="card-body p-0">
                <table class="table table-dark table-hover mb-0">
                    <tbody id="sums-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card shadow-sm border-0 bg-dark text-white">
            <div class="card-header bg-transparent border-0 pt-3">
                <h6 class="text-muted text-uppercase small fw-bold text-success">Food & Drink: Deep Dive</h6>
            </div>
            <div class="card-body">
                <div style="height: 300px; position: relative;">
                    <canvas id="foodChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

[Image of a financial dashboard with a date range picker and filter controls]


<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
let spendingChart, foodChart;
let rawData = [];

async function fetchData() {
    const start = document.getElementById('startDate').value;
    const end = document.getElementById('endDate').value;
    let params = (start && end) ? `?start=${start}&end=${end}` : '';

    try {
        const [resMain, resFood] = await Promise.all([
            fetch(`/api/spending${params}`),
            fetch(`/api/food_drink_breakdown${params}`)
        ]);

        rawData = await resMain.json();
        const foodData = await resFood.json();

        renderDashboard();
        renderFoodChart(foodData);
    } catch (e) {
        console.error("Dashboard fetch failed", e);
    }
}

function renderDashboard() {
    const userView = document.getElementById('userFilter').value;
    const tableBody = document.getElementById('sums-table-body');
    tableBody.innerHTML = '';

    const filtered = rawData.map(item => {
        let amt = 0;
        if (userView === 'all') amt = item.total_household;
        else if (userView === '0') amt = item.total_gus;
        else if (userView === '1') amt = item.total_joules;
        return { name: item.parent_name, total: parseFloat(amt || 0) };
    }).filter(i => i.total > 0.01);

    if (spendingChart) spendingChart.destroy();

    const grandTotal = filtered.reduce((sum, i) => sum + i.total, 0);
    document.getElementById('totalDisplay').innerText = `€${grandTotal.toFixed(2)}`;

    tableBody.innerHTML = filtered.map(i => `
        <tr>
            <td class="ps-3">${i.name}</td>
            <td class="text-end pe-3 text-info fw-bold">€${i.total.toFixed(2)}</td>
        </tr>
    `).join('');

    const ctx = document.getElementById('spendingChart').getContext('2d');
    spendingChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: filtered.map(i => i.name),
            datasets: [{
                data: filtered.map(i => i.total),
                backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796'],
                borderWidth: 0
            }]
        },
        options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#aaa' } } } }
    });
}

function renderFoodChart(data) {
    const userView = document.getElementById('userFilter').value;
    const ctx = document.getElementById('foodChart').getContext('2d');
    if (foodChart) foodChart.destroy();

    const filtered = data.map(item => {
        let amt = 0;
        if (userView === 'all') amt = item.total_household;
        else if (userView === '0') amt = item.total_gus;
        else if (userView === '1') amt = item.total_joules;
        return { name: item.subcategory, total: parseFloat(amt || 0) };
    }).filter(i => i.total > 0.01);

    if (filtered.length > 0) {
        foodChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: filtered.map(i => i.name),
                datasets: [{
                    data: filtered.map(i => i.total),
                    backgroundColor: ['#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#4e73df'],
                    borderWidth: 0
                }]
            },
            options: { maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#aaa' } } } }
        });
    }
}

function resetToAllTime() {
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    fetchData();
}

document.addEventListener('DOMContentLoaded', fetchData);
</script>
{% endblock %}