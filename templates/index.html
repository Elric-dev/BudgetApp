{% extends "layout.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="text-info"><i class="bi bi-speedometer2 me-2"></i>Executive Dashboard</h3>
    <div class="d-flex align-items-center gap-2">
        <label class="small text-light text-uppercase fw-bold mb-0">Profile:</label>
        <select id="userSelect" class="form-select bg-dark text-white border-secondary" style="width: 160px;" onchange="updateDashboard()">
            <option value="0">Gus</option>
            <option value="1">Joules</option>
            <option value="2">üè† Household</option>
    </select>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-dark border-info p-3 shadow-sm">
            <h6 class="text-muted small text-uppercase fw-bold">Current Net Worth</h6>
            <h3 id="dash-net-worth" class="text-white fw-bold mb-0">‚Ç¨0.00</h3>
            <small class="text-info">Total Equity</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-dark border-secondary p-3 shadow-sm">
            <h6 class="text-muted small text-uppercase fw-bold">Monthly Net Income</h6>
            <h3 id="dash-income" class="text-success fw-bold mb-0">‚Ç¨0.00</h3>
            <small class="text-muted">Current Flow</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-dark border-secondary p-3 shadow-sm">
            <h6 class="text-muted small text-uppercase fw-bold">Monthly Spending</h6>
            <h2 id="dash-spending" class="text-warning fw-bold mb-0">‚Ç¨0.00</h2>
            <small class="text-muted">Total Burn</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-dark border-secondary p-3 shadow-sm">
            <h6 class="text-muted small text-uppercase fw-bold">Savings Rate</h6>
            <h3 id="dash-savings" class="text-white fw-bold mb-0">‚Ç¨0.00</h3>
            <div class="progress mt-2" style="height: 6px; background-color: #000;">
                <div id="savings-bar" class="progress-bar bg-success" style="width: 0%"></div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card bg-dark border-secondary p-3 shadow-lg">
            <h6 class="text-info small fw-bold text-uppercase mb-3">Wealth Trend (Wealth vs. Income)</h6>
            <div style="height: 350px;">
                <canvas id="dashNetWorthChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-dark border-secondary p-3 shadow-lg">
            <h6 class="text-info small fw-bold text-uppercase mb-3">Spending Breakdown</h6>
            <div style="height: 350px;">
                <canvas id="dashSpendingChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
let nwChart, spendingChart;

async function updateDashboard() {
    const userId = document.getElementById('userSelect').value;

    try {
        // 1. Fetch KPI Summary Data
        const res = await fetch(`/api/dashboard/summary?user_id=${userId}`);
        const data = await res.json();

        document.getElementById('dash-net-worth').innerText = `‚Ç¨${data.net_worth.toLocaleString('en-IE', {minimumFractionDigits: 2})}`;
        document.getElementById('dash-income').innerText = `‚Ç¨${data.income.toLocaleString('en-IE', {minimumFractionDigits: 2})}`;
        document.getElementById('dash-spending').innerText = `‚Ç¨${data.spent.toLocaleString('en-IE', {minimumFractionDigits: 2})}`;
        
        const savings = data.savings;
        const savingsEl = document.getElementById('dash-savings');
        savingsEl.innerText = `‚Ç¨${savings.toLocaleString('en-IE', {minimumFractionDigits: 2})}`;
        savingsEl.className = savings >= 0 ? 'fw-bold mb-0 text-success' : 'fw-bold mb-0 text-danger';

        const savingsPct = data.income > 0 ? (savings / data.income) * 100 : 0;
        document.getElementById('savings-bar').style.width = `${Math.min(Math.max(savingsPct, 0), 100)}%`;

        // 2. Load the Wealth Trend Chart
        const hRes = await fetch(`/api/finance/history?user_id=${userId}`);
        const hData = await hRes.json();
        renderNetWorthChart(hData);

        // 3. Load the Spending Pie Chart
        const sRes = await fetch(`/api/spending/category?user_id=${userId}`);
        const sData = await sRes.json();
        renderSpendingChart(sData);

    } catch (err) {
        console.error("Dashboard Sync Failed:", err);
    }
}

function renderNetWorthChart(data) {
    const ctx = document.getElementById('dashNetWorthChart').getContext('2d');
    if (nwChart) nwChart.destroy();

    nwChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.dates,
            datasets: [
                { label: 'Net Worth', data: data.nw_values, borderColor: '#0dcaf0', yAxisID: 'y', tension: 0.3, fill: true, backgroundColor: 'rgba(13, 202, 240, 0.1)' },
                { label: 'Net Income', data: data.inc_values, borderColor: '#2ecc71', yAxisID: 'y1', borderDash: [5,5], tension: 0.3 }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: {
                y: { position: 'left', grid: { color: '#222' }, ticks: { color: '#0dcaf0' } },
                y1: { position: 'right', grid: { display: false }, ticks: { color: '#2ecc71' } },
                x: { ticks: { color: '#888' } }
            },
            plugins: { legend: { labels: { color: '#fff' } } }
        }
    });
}

function renderSpendingChart(data) {
    const ctx = document.getElementById('dashSpendingChart').getContext('2d');
    if (spendingChart) spendingChart.destroy();

    spendingChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: data.labels,
            datasets: [{
                data: data.values,
                backgroundColor: ['#0dcaf0', '#2ecc71', '#ffc107', '#fd7e14', '#6610f2', '#e83e8c'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom', labels: { color: '#fff', padding: 20 } }
            },
            cutout: '70%'
        }
    });
}

document.addEventListener('DOMContentLoaded', updateDashboard);
</script>
{% endblock %}